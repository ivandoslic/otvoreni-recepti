COPY (SELECT r.id AS id_recepta, r.naziv AS naziv_recepta, r.opis AS opis_recepta, r.youtube_url AS recept_youtube_url, r.koraci_recepta AS koraci_recepta, r.wiki_url AS recept_wiki_url, r.vrijeme_pripreme AS vrijeme_pripreme, r.vrijeme_kuhanja AS vrijeme_kuhanja, r.broj_porcija AS broj_porcija, r.tezina AS tezina, d.id AS id_drzave, d.naziv AS naziv_drzave, d.glavni_grad AS glavni_grad, d.flag_url AS zastava_url, d.region AS regija, i.naziv_sastojka AS naziv_sastojka, i.kolicina AS kolicina, i.mjerna_jedinica AS mjerna_jedinica FROM recepti r LEFT JOIN drzave d ON r.drzava_id = d.id LEFT JOIN recept_sastojci rs ON r.id = rs.recept_id LEFT JOIN sastojci s ON rs.sastojak_id = s.id CROSS JOIN LATERAL (SELECT s.naziv AS naziv_sastojka, rs.kolicina AS kolicina, rs.mjerna_jedinica AS mjerna_jedinica) AS i GROUP BY r.id, d.id, i.naziv_sastojka, i.kolicina, i.mjerna_jedinica ORDER BY r.id, i.naziv_sastojka) TO 'D:/Faks/OR/or-labosi/recipes.csv' WITH (FORMAT CSV, HEADER);

COPY (
    SELECT json_agg(
        json_build_object(
            'id_recepta', r.id,
            'naziv_recepta', r.naziv,
            'opis_recepta', r.opis,
            'recept_youtube_url', r.youtube_url,
            'koraci_recepta', r.koraci_recepta,
            'recept_wiki_url', r.wiki_url,
            'vrijeme_pripreme', r.vrijeme_pripreme,
            'vrijeme_kuhanja', r.vrijeme_kuhanja,
            'broj_porcija', r.broj_porcija,
            'tezina', r.tezina,
            'drzava', json_build_object(
                'drzava_id', d.id,
                'naziv_drzave', d.naziv,
                'glavni_grad', d.glavni_grad,
                'zastava_url', d.flag_url,
                'regija', d.region
            ),
            'sastojci', sastojci.sastojci
        )
    ) AS recepti
    FROM recepti r
    LEFT JOIN drzave d ON r.drzava_id = d.id
    LEFT JOIN (
        SELECT rs.recept_id, json_agg(
            json_build_object(
                'naziv_sastojka', s.naziv,
                'kolicina', rs.kolicina,
                'mjerna_jedinica', rs.mjerna_jedinica
            )
        ) AS sastojci
        FROM recept_sastojci rs
        LEFT JOIN sastojci s ON rs.sastojak_id = s.id
        GROUP BY rs.recept_id
    ) AS sastojci ON r.id = sastojci.recept_id
) TO 'D:/Faks/OR/or-labosi/recipes.json';